{% extends 'base.html' %}

{% block content %}
<style>
    /* Ocultar barra de scroll en tabs para est칠tica */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Animaci칩n suave entre pesta침as */
    .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilo de Inputs m치s profesional */
    .form-input {
        @apply w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20 transition-all duration-200 outline-none;
    }

    /* Estilos espec칤ficos para la tabla responsiva */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
</style>

<div class="max-w-6xl mx-auto pb-32 px-4 sm:px-6">

    <div class="text-center mt-[25px] md:mt-0 pt-8 mb-6">
        <h1 class="text-xl md:text-3xl font-extrabold text-gray-900 tracking-tight">
            Evaluaci칩n de Riesgo Social
        </h1>
        <p class="text-[12px] md:text-sm text-gray-500 mt-2">Complete la informaci칩n solicitada en cada secci칩n.</p>
    </div>

    <div
        class="hidden lg:block sticky top-16 z-30 bg-gray-100/95 backdrop-blur-sm -mx-4 px-4 sm:mx-0 sm:px-0 mb-6 py-2 border-b border-gray-200/50">
        <div class="flex space-x-2 overflow-x-auto scrollbar-hide snap-x" id="tabs-container">
            <button type="button"
                class=" tab-btn active snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-blue-600 text-white shadow-md transition-all duration-200 flex-shrink-0"
                data-index="0">
                Datos Generales
            </button>
            <button type="button"
                class="up tab-btn snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:text-gray-900 transition-all duration-200 flex-shrink-0"
                data-index="1">
                Estructura Familiar
            </button>

            {% for dim in dimensiones %}
            <button type="button"
                class="tab-btn snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:text-gray-900 transition-all duration-200 flex-shrink-0"
                data-index="{{ forloop.counter|add:1 }}">
                {{ dim.nombre }}
            </button>
            {% endfor %}
        </div>
    </div>

    <form method="POST" id="form-riesgo" class="relative">
        {% csrf_token %}

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[500px]">

            <div class="tab-pane fade-in p-6 md:p-8 block" data-step="0">
                <div class="mb-8 border-l-4 border-blue-500 pl-4">
                    <h2 class="text-[14px] md:text-xl font-bold text-gray-800">Datos Generales del Profesional</h2>
                    <p class="text-[12px] md:text-sm text-gray-400">Detalle del profesional</p>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Nombres:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="text" name="nombres_encuestado" required class="form-input "
                                placeholder="Ingrese apellidos y nombres completos">
                        </div>
                        <div>
                            <label
                                class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Apellidos:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="text" name="apellidos_encuestado" required class="form-input "
                                placeholder="Ingrese apellidos y nombres completos">
                        </div>

                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Edad:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="number" name="edad" required class="form-input" placeholder="Ej: 15">
                        </div>
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Fecha de
                                Nacimiento:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="date" name="fecha_nacimiento" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">DNI:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="text" name="dni" required maxlength="8" class="form-input" placeholder="DNI">
                        </div>
                    </div>

                    <div
                        class="grid grid-cols-1 md:grid-cols-12 gap-6 bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="md:col-span-4">
                            <label class="block  text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Sexo:</label>
                            <div class="radio-group mt-2">
                                <label class="radio-label mr-4 text-[12px] md:text-sm">
                                    <input type="radio" class=" " name="sexo" value="M" required> Masculino
                                </label>
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="sexo" value="F" class="radio-input "> Femenino
                                </label>
                            </div>
                        </div>
                        <div class="md:col-span-8">
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Nivel
                                Educativo:</label>
                            <div class="radio-group mt-2">
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="nivel_educativo" required value="Primaria"
                                        class="radio-input ">
                                    Primaria
                                </label>
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="nivel_educativo" value="Secundaria" class="radio-input ">
                                    Secundaria
                                </label>
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="nivel_educativo" value="Universidad" class="radio-input ">
                                    Universidad
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label
                                class="form-label font-bold text-gray-700 mb-1 block  text-[12px] md:text-sm">Departamento
                                (Actual)</label>
                            <select name="ubigeo_departamento" id="cbo_dep_actual"
                                class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none"
                                onchange="cargarProvincias('actual')" required>
                                <option value="">-- Seleccione --</option>
                                {% for d in departamentos %}
                                <option value="{{ d.id }}">{{ d.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label
                                class="form-label font-bold text-gray-700 mb-1 block text-[12px] md:text-sm">Provincia
                                (Actual)</label>
                            <select name="ubigeo_provincia" id="cbo_prov_actual"
                                class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none"
                                onchange="cargarDistritos('actual')" disabled>
                                <option value="">-- Primero Dpto --</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label font-bold text-gray-700 mb-1 block text-[12px] md:text-sm">Distrito
                                (Actual)</label>
                            <select name="ubigeo_distrito" id="cbo_dist_actual"
                                class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none"
                                disabled>
                                <option value="">-- Primero Prov --</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Direcci칩n
                            Actual:</label>
                        <input
                            class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                            type="text" name="direccion" required class="form-input"
                            placeholder="Av./Calle, N칰mero/Interior">
                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Tel칠fono de
                                contacto:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="tel" name="telefono" required>
                        </div>
                        <div><label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Email:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="email" name="email" required>
                        </div>
                    </div>

                    <div class="bg-blue-50/50 p-6 rounded-xl border border-blue-100 mt-4">
                        <label class="text-blue-800 font-bold mb-4 block border-b border-blue-100 pb-2">En caso de
                            emergencia contactar a:</label>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <label class="text-[12px] md:text-sm font-semibold text-gray-500  ">Nombre Completo</label>
                                <input type="text" name="emergencia_contacto"
                                    class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                    required>
                            </div>
                            <div>
                                <label class="text-[12px] md:text-sm font-semibold text-gray-500 ">Tel칠fono</label>
                                <input type="text" name="emergencia_telefono"
                                    class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                    required>
                            </div>
                            <div>
                                
                                <label class="text-[12px] md:text-sm font-semibold text-gray-500 ">Parentesco</label>
                                <select name="emergencia_parentesco" required
                                    class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3  py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none">
                                    <option value="">Seleccione parentesco...</option>
                                    <option value="Padre">Padre</option>
                                    <option value="Madre">Madre</option>
                                    <option value="Hijo">Hijo</option>
                                    <option value="Hija">Hija</option>
                                    <option value="Hermano">Hermano</option>
                                    <option value="Hermana">Hermana</option>
                                    <option value="Abuelo">Abuelo</option>
                                    <option value="Abuela">Abuela</option>
                                    <option value="T칤o">T칤o</option>
                                    <option value="T칤a">T칤a</option>
                                    <option value="Primo">Primo</option>
                                    <option value="Prima">Prima</option>
                                    <option value="Esposo">Esposo</option>
                                    <option value="Esposa">Esposa</option>
                                    <option value="Pareja">Pareja</option>
                                    <option value="Suegro">Suegro</option>
                                    <option value="Suegra">Suegra</option>
                                    <option value="Cu침ado">Cu침ado</option>
                                    <option value="Cu침ada">Cu침ada</option>
                                    <option value="Yerno">Yerno</option>
                                    <option value="Nuera">Nuera</option>
                                    <option value="Amigo">Amigo</option>
                                    <option value="Amiga">Amiga</option>
                                    <option value="Vecino">Vecino</option>
                                    <option value="Vecina">Vecina</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="tab-pane fade-in p-6 md:p-8 hidden" data-step="1">
                <div class="mb-8 border-l-4 border-blue-500 pl-4">
                    <h2 class="text-[14px] md:text-xl font-bold text-gray-800">Estructura Familiar</h2>
                    <p class="text-[12px] md:text-sm text-gray-400">Detalle de los miembros del hogar</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Jefe de Hogar</label>
                        <input type="text" name="jefe_hogar"
                            oninput="this.value = this.value.replace(/[^a-zA-Z치칠칤칩칰츼칄칈칍칔침칌\s]/g, '')"
                            class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 "
                            placeholder="Nombre del jefe/a" required>
                    </div>
                    <div>
                        <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">N칰mero total de integrantes</label>
                        <input type="number" name="num_integrantes" id="input_num_integrantes" min="0"
                            class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 transition-all"
                            placeholder="Ej: 3" required onfocus="this.dataset.valorPrevio = this.value"
                            oninput="controlarLimiteFamilia(this)">
                    </div>
                </div>

                <div id="tabla-container-familia"
                    class="table-container border border-gray-200 mb-4 hidden transition-all duration-300">
                    <table class="w-full text-[12px] md:text-sm text-left min-w-[1000px]">
                        <thead class="text-xs text-white  bg-blue-600">
                            <tr>
                                <th class="px-3 py-4 w-10 text-center">#</th>
                                <th class="px-3 py-4 min-w-[180px]">Nombres y Apellidos</th>
                                <th class="px-3 py-4 w-32">Parentesco</th>
                                <th class="px-3 py-4 w-20">Edad</th>
                                <th class="px-3 py-4 w-24">Sexo</th>
                                <th class="px-3 py-4 w-32">Est. Civil</th>
                                <th class="px-3 py-4 w-32">Nivel Edu.</th>
                                <th class="px-3 py-4 w-32">Ocupaci칩n</th>
                                <th class="px-3 py-4 w-28">Ingresos</th>
                                <th class="px-3 py-4 w-12"></th>
                            </tr>
                        </thead>
                        <tbody id="familiares-body" class=" text-[12px] md:text-sm divide-y divide-gray-100 bg-white">
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end mb-6">
                    <button type="button" id="btn-add-familiar" onclick="agregarFilaFamiliar()"
                        class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold transition-colors border border-blue-200 disabled:opacity-50 disabled:cursor-not-allowed hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Agregar Integrante
                    </button>
                </div>

                <input type="hidden" name="total_familiares" id="total_familiares" value="0">

                <div class="mt-6">
                    <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Observaciones</label>
                    <textarea name="observaciones_familia" rows="3"
                        class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20"></textarea>
                </div>
            </div>


            {% for dim in dimensiones %}
            <div class="tab-pane fade-in p-6 md:p-8 hidden" data-step="{{ forloop.counter|add:1 }}">
                <div class="mb-8 border-l-4 border-blue-500 pl-4">
                    <h2 class="text-xl font-bold text-gray-800">{{ dim.nombre }}</h2>
                    <p class="text-sm text-gray-400 italic">{{ dim.descripcion }}</p>
                </div>

                <div class="space-y-5">
                    {% for pregunta in dim.preguntas.all %}
                    <div
                        class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm hover:border-blue-300 hover:shadow-md transition-all duration-200">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-shrink-0">
                                <span
                                    class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-bold text-sm shadow-sm">
                                    {{ pregunta.orden }}
                                </span>
                            </div>

                            <div class="flex-grow">
                                <label
                                    class="block text-gray-800 font-medium mb-3 text-sm md:text-base leading-relaxed">
                                    {{ pregunta.enunciado }}
                                </label>

                                <div class="relative">
                                    <select name="pregunta_{{ pregunta.id }}" required
                                        class="block w-full appearance-none rounded-lg border border-gray-300 bg-gray-50 py-3 px-4 pr-10 leading-tight text-gray-700 focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors cursor-pointer">
                                        <option value="">Seleccione una opci칩n...</option>
                                        {% for opcion in pregunta.opciones.all %}
                                        <option value="{{ opcion.id }}">
                                            {{ opcion.texto }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                        <svg class="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

        </div>

        <div
            class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40">
            <div class="max-w-5xl mx-auto flex justify-between items-center gap-4">
                <button type="button" onclick="confirmarSalida()"
                    class="px-4 py-3 rounded-xl border border-red-200 text-red-600 font-bold hover:bg-red-50 transition w-full sm:w-auto flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                    <span class=" sm:inline">Salir</span>
                </button>

                <button type="button" id="btn-prev"
                    class="px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 active:scale-95 transition hidden w-full sm:w-auto">
                    Anterior
                </button>

                <div class="hidden sm:block text-xs font-semibold text-gray-400  tracking-widest">
                    Secci칩n <span id="current-step-display">1</span> / <span id="total-steps-display">X</span>
                </div>

                <button type="button" id="btn-next"
                    class="px-8 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 hover:shadow-blue-500/30 active:scale-95 transition w-full sm:w-auto">
                    Siguiente
                </button>

                <button type="submit" id="btn-submit"
                    class="hidden px-8 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg hover:bg-green-700 hover:shadow-green-500/30 active:scale-95 transition w-full sm:w-auto">
                    Finalizar y Guardar
                </button>
            </div>
        </div>

    </form>


    <script>
        // UBICACI칍N: Dentro de <script>, antes de document.addEventListener...

        function confirmarSalida() {
            // URL a la que quieres volver (Dashboard o Mis Encuestas)
            const urlDestino = "{% url 'mis_encuestas' %}";

            if (typeof formularioSucio !== 'undefined' && formularioSucio) {
                // Si hay datos modificados, preguntamos
                const confirmar = confirm("丘멆잺 ATENCI칍N: Hay datos sin guardar.\n\nSi sale ahora, perder치 el progreso de esta ficha.\n\n쮼st치 seguro que desea salir?");

                if (confirmar) {
                    // Importante: Desactivamos la bandera para que el navegador no bloquee la redirecci칩n
                    formularioSucio = false;
                    window.location.href = urlDestino;
                }
            } else {
                // Si no hay cambios, salimos directamente
                window.location.href = urlDestino;
            }
        }
        document.addEventListener("DOMContentLoaded", function () {

            // ======================================================
            // 1. CONFIGURACI칍N INICIAL
            // ======================================================
            let currentStep = 0;
            const steps = document.querySelectorAll(".tab-pane");
            const tabButtons = document.querySelectorAll(".tab-btn");
            const btnNext = document.getElementById("btn-next");
            const btnPrev = document.getElementById("btn-prev");
            const btnSubmit = document.getElementById("btn-submit");
            const totalSteps = steps.length;

            // Inicializar tabla de familiares
            if (document.getElementById('familiares-body')) {
                agregarFilaFamiliar();
            }

            // ======================================================
            // 2. PROTECCI칍N CONTRA CIERRE ACCIDENTAL
            // ======================================================
            let formularioSucio = false;
            const form = document.getElementById('form-riesgo');

            form.addEventListener('change', () => { formularioSucio = true; });
            form.addEventListener('input', () => { formularioSucio = true; });

            window.addEventListener('beforeunload', function (e) {
                if (formularioSucio) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            form.addEventListener('submit', () => { formularioSucio = false; });

            // ======================================================
            // 3. L칍GICA DE VALIDACI칍N (EL CORAZ칍N DEL PROBLEMA)
            // ======================================================

            function mostrarError(input) {
                // Borde rojo para inputs normales
                input.classList.remove('border-gray-300');
                input.classList.add('border-red-500', 'ring-2', 'ring-red-100');

                // Para Radio Buttons, buscamos su contenedor padre para pintarlo
                if (input.type === 'radio') {
                    const parent = input.closest('.radio-group') || input.parentElement;
                    parent.classList.add('border', 'border-red-500', 'rounded-lg', 'p-1', 'bg-red-50');
                }
            }

            function limpiarError(input) {
                input.classList.remove('border-red-500', 'ring-2', 'ring-red-100');
                input.classList.add('border-gray-300');

                if (input.type === 'radio') {
                    const parent = input.closest('.radio-group') || input.parentElement;
                    parent.classList.remove('border', 'border-red-500', 'rounded-lg', 'p-1', 'bg-red-50');
                }
            }

            function validarPasoActual() {
                const currentPanel = steps[currentStep];
                let esValido = true;
                let primerError = null;

                // =================================================================
                // 1. VALIDACI칍N ESPECIAL: COINCIDENCIA DE TABLA (SOLO EN PASO 1)
                // =================================================================
                if (currentStep === 1) { // 1 es el 칤ndice de "Estructura Familiar"
                    const inputTotal = document.getElementById('input_num_integrantes');
                    const tbody = document.getElementById('familiares-body');

                    // Asegurarnos que existan los elementos
                    if (inputTotal && tbody) {
                        const totalEsperado = parseInt(inputTotal.value) || 0;
                        // Contamos solo las filas TR directas del body
                        const filasReales = tbody.querySelectorAll('tr').length;

                        // A. Validar que el n칰mero total sea mayor a 0
                        if (totalEsperado <= 0) {
                            alert("丘멆잺 Por favor, ingrese el n칰mero total de integrantes (m칤nimo 1).");
                            inputTotal.focus();
                            mostrarError(inputTotal);
                            return false; // <--- BLOQUEA EL AVANCE AQU칈
                        }

                        // B. Validar coincidencia exacta (Input vs Tabla)
                        if (totalEsperado !== filasReales) {
                            alert(`游띔 ERROR DE CANTIDAD:\n\nUd. indic칩: ${totalEsperado} integrantes.\nEn la tabla hay: ${filasReales} filas.\n\nPor favor agregue o elimine integrantes hasta que coincidan.`);

                            // Resaltar visualmente el bot칩n de agregar
                            const btnAdd = document.getElementById('btn-add-familiar');
                            if (btnAdd) {
                                btnAdd.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                btnAdd.classList.add('ring-4', 'ring-red-400', 'bg-red-50');
                                setTimeout(() => btnAdd.classList.remove('ring-4', 'ring-red-400', 'bg-red-50'), 2000);
                            }
                            return false; // <--- BLOQUEA EL AVANCE AQU칈
                        }
                    }
                }

                // =================================================================
                // 2. VALIDACI칍N EST츼NDAR DE CAMPOS VAC칈OS (TU L칍GICA ACTUAL)
                // =================================================================

                // A. INPUTS VISIBLES
                const inputs = currentPanel.querySelectorAll("input:not([type='radio']):not([type='hidden']), select, textarea");

                inputs.forEach(input => {
                    // Verificar si es visible y requerido
                    if (input.offsetParent !== null && input.hasAttribute('required')) {
                        if (!input.value.trim()) {
                            esValido = false;
                            mostrarError(input);
                            if (!primerError) primerError = input;
                        } else {
                            limpiarError(input);
                        }
                    }
                });

                // B. RADIO BUTTONS
                const radioNames = new Set();
                currentPanel.querySelectorAll("input[type='radio'][required]").forEach(r => {
                    if (r.offsetParent !== null) radioNames.add(r.name);
                });

                radioNames.forEach(name => {
                    const radios = currentPanel.querySelectorAll(`input[name="${name}"]`);
                    const algunoMarcado = Array.from(radios).some(r => r.checked);

                    if (!algunoMarcado) {
                        esValido = false;
                        radios.forEach(r => mostrarError(r));
                        if (!primerError) primerError = radios[0];
                    } else {
                        radios.forEach(r => limpiarError(r));
                    }
                });

                // ACCI칍N FINAL: SCROLL AL ERROR
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (primerError.type !== 'radio') primerError.focus({ preventScroll: true });

                    primerError.classList.add('animate-pulse');
                    setTimeout(() => primerError.classList.remove('animate-pulse'), 500);
                }

                return esValido;
            }
            // ======================================================
            // 4. NAVEGACI칍N (TABS)
            // ======================================================
            function updateButtons() {
                if (currentStep === 0) btnPrev.classList.add("hidden");
                else btnPrev.classList.remove("hidden");

                if (currentStep === totalSteps - 1) {
                    btnNext.classList.add("hidden");
                    btnSubmit.classList.remove("hidden");
                } else {
                    btnNext.classList.remove("hidden");
                    btnSubmit.classList.add("hidden");
                }

                // Actualizar textos de pasos
                const display = document.getElementById("current-step-display");
                if (display) display.innerText = currentStep + 1;
            }

            function showStep(index) {
                steps.forEach((step, idx) => {
                    if (idx === index) {
                        step.classList.remove("hidden");
                        step.classList.add("block");
                    } else {
                        step.classList.add("hidden");
                        step.classList.remove("block");
                    }
                });

                tabButtons.forEach((btn, idx) => {
                    if (idx === index) {
                        btn.classList.add("bg-blue-600", "text-white", "shadow-md");
                        btn.classList.remove("bg-white", "text-gray-600", "border");
                        // Auto-scroll del men칰 superior en m칩vil
                        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    } else {
                        btn.classList.remove("bg-blue-600", "text-white", "shadow-md");
                        btn.classList.add("bg-white", "text-gray-600", "border");
                    }
                });

                currentStep = index;
                updateButtons();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // EVENTO: BOT칍N SIGUIENTE
            btnNext.addEventListener("click", function () {
                if (validarPasoActual()) {
                    if (currentStep < totalSteps - 1) {
                        showStep(currentStep + 1);
                    }
                } else {
                    console.log("Faltan campos obligatorios");
                }
            });

            // EVENTO: BOT칍N ANTERIOR
            btnPrev.addEventListener("click", function () {
                if (currentStep > 0) showStep(currentStep - 1);
            });

            // EVENTO: TABS SUPERIORES (Clickeables)
            tabButtons.forEach((btn, idx) => {
                btn.addEventListener("click", function () {

                    // CASO 1: El usuario quiere retroceder (idx < currentStep)
                    // Lo permitimos siempre para que pueda corregir
                    if (idx < currentStep) {
                        showStep(idx);
                        return;
                    }

                    // CASO 2: El usuario quiere avanzar (idx > currentStep)
                    if (idx > currentStep) {

                        // A. Evitar saltos grandes (Ej: del paso 1 al 3 sin pasar por el 2)
                        if (idx > currentStep + 1) {
                            alert("游뛂 Por favor, avance en orden secuencial completando cada secci칩n.");
                            return;
                        }

                        // B. Validar el paso actual antes de permitir el cambio
                        if (validarPasoActual()) {
                            showStep(idx);
                        } else {
                            // Si falla, validarPasoActual ya muestra los errores y hace focus
                            console.log("Bloqueo por validaci칩n incompleta");
                        }
                    }
                });
            });

            // Limpiar errores en tiempo real mientras el usuario escribe
            form.addEventListener('input', function (e) {
                if (e.target.classList.contains('border-red-500') || e.target.type === 'radio') {
                    limpiarError(e.target);
                }
            });

            // Iniciar
            showStep(0);
        });

        // ======================================================
        // 5. FUNCIONES DE NEGOCIO (Ubigeo, Familia, Toggle)
        // ======================================================

        // --- UBIGEO ---
        function cargarProvincias(tipo) {
            const depId = document.getElementById(`cbo_dep_${tipo}`).value;
            const cboProv = document.getElementById(`cbo_prov_${tipo}`);
            const cboDist = document.getElementById(`cbo_dist_${tipo}`);

            cboProv.innerHTML = '<option value="">Cargando...</option>'; cboProv.disabled = true;
            if (cboDist) { cboDist.innerHTML = '<option value="">--</option>'; cboDist.disabled = true; cboProv.required = true; }

            if (depId) {
                fetch(`/ubigeo/api/provincias/?dep_id=${depId}`)
                    .then(r => r.json()).then(data => {
                        let html = '<option value="">-- Seleccione --</option>';
                        data.forEach(d => html += `<option value="${d.id}">${d.nombre}</option>`);
                        cboProv.innerHTML = html; cboProv.disabled = false;
                    });
            } else {
                cboProv.innerHTML = '<option value="">-- Seleccione Dpto --</option>';
            }
        }

        function cargarDistritos(tipo) {
            const provId = document.getElementById(`cbo_prov_${tipo}`).value;
            const cboDist = document.getElementById(`cbo_dist_${tipo}`);
            if (!cboDist) return;

            cboDist.innerHTML = '<option value="">Cargando...</option>'; cboDist.disabled = true; cboDist.required = true;
            if (provId) {
                fetch(`/ubigeo/api/distritos/?prov_id=${provId}`)
                    .then(r => r.json()).then(data => {
                        let html = '<option value="">-- Seleccione --</option>';
                        data.forEach(d => html += `<option value="${d.id}">${d.nombre}</option>`);
                        cboDist.innerHTML = html; cboDist.disabled = false;
                    });
            } else {
                cboDist.innerHTML = '<option value="">-- Seleccione Prov --</option>';
            }
        }


        // ======================================================
        // LOGICA DE FAMILIA (CON PROTECCI칍N DE BORRADO)
        // ======================================================

        // Inicializar contador global
        let contadorFamiliares = 0;

        // Funci칩n principal disparada por el input
        function controlarLimiteFamilia(input) {
            const nuevoLimite = parseInt(input.value) || 0;
            const tablaContainer = document.getElementById('tabla-container-familia');
            const btnAdd = document.getElementById('btn-add-familiar');
            const tbody = document.getElementById('familiares-body');
            const filas = tbody.querySelectorAll('tr');
            const filasActuales = filas.length;

            // 1. GESTI칍N DE REDUCCI칍N (El usuario baj칩 el n칰mero)
            if (nuevoLimite < filasActuales) {
                const filasSobrantes = Array.from(filas).slice(nuevoLimite); // Las filas que se ir칤an

                // Verificamos si alguna de las filas sobrantes tiene datos escritos
                let hayDatos = filasSobrantes.some(fila => {
                    const inputs = fila.querySelectorAll('input, select');
                    return Array.from(inputs).some(i => i.value.trim() !== '' && i.type !== 'hidden');
                });

                if (hayDatos) {
                    const confirmar = confirm(`丘멆잺 ATENCI칍N:\n\nAl reducir el n칰mero a ${nuevoLimite}, se eliminar치n las 칰ltimas ${filasActuales - nuevoLimite} filas que contienen datos.\n\n쮼st치 seguro de continuar?`);

                    if (!confirmar) {
                        // Si cancela, restauramos el valor anterior del input y salimos
                        input.value = input.dataset.valorPrevio || filasActuales;
                        return;
                    }
                }

                // Si no hay datos o confirm칩, eliminamos las filas sobrantes
                filasSobrantes.forEach(fila => fila.remove());
                renumerarFilas(); // Reordenamos 칤ndices
            }

            // 2. ACTUALIZAR VISIBILIDAD Y BOT칍N
            if (nuevoLimite > 0) {
                tablaContainer.classList.remove('hidden');
                btnAdd.classList.remove('hidden');
            } else {
                tablaContainer.classList.add('hidden');
                btnAdd.classList.add('hidden');
            }

            // 3. ACTUALIZAR ESTADO DEL BOT칍N "AGREGAR"
            verificarTope(nuevoLimite);

            // 4. GUARDAR EL NUEVO VALOR COMO "PREVIO" (Para la pr칩xima vez)
            input.dataset.valorPrevio = nuevoLimite;
        }

        // Funci칩n auxiliar para bloquear/desbloquear bot칩n agregar
        function verificarTope(limite) {
            const tbody = document.getElementById('familiares-body');
            const btnAdd = document.getElementById('btn-add-familiar');
            // Contamos filas reales en el DOM
            const filasActuales = tbody.querySelectorAll('tr').length;

            if (filasActuales >= limite) {
                btnAdd.disabled = true;
                btnAdd.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
                btnAdd.classList.remove('hover:bg-blue-100', 'bg-blue-50', 'text-blue-600');
                btnAdd.innerHTML = `<span class="font-normal">L칤mite completado (${limite}/${limite})</span>`;
            } else {
                btnAdd.disabled = false;
                btnAdd.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
                btnAdd.classList.add('hover:bg-blue-100', 'bg-blue-50', 'text-blue-600');
                btnAdd.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Agregar Integrante
            `;
            }
        }

        function agregarFilaFamiliar() {
            const inputNum = document.getElementById('input_num_integrantes');
            const limite = parseInt(inputNum.value) || 0;
            const tbody = document.getElementById('familiares-body');

            // Validaci칩n de seguridad (L칤mite)
            if (tbody.querySelectorAll('tr').length >= limite) {
                inputNum.focus();
                inputNum.classList.add('ring-4', 'ring-red-200');
                setTimeout(() => inputNum.classList.remove('ring-4', 'ring-red-200'), 500);
                return;
            }

            const row = document.createElement('tr');
            row.className = "hover:bg-blue-50 transition group";

            // NOTA: He mantenido las clases de estilo Tailwind que ya ten칤as para consistencia
            row.innerHTML = `
            <td class="px-3 py-2 text-center text-gray-400 font-bold index-cell"></td>
            
            <td class="p-1">
                <input type="text" data-field="nombre" required
                    oninput="this.value = this.value.replace(/[^a-zA-Z치칠칤칩칰츼칄칈칍칔침칌\\s]/g, '')"
                    class="w-full text-[12px] md:text-sm bg-transparent border-b border-transparent focus:border-blue-500 focus:ring-0   p-1 placeholder-gray-400" 
                    placeholder="Nombres y Apellidos">
            </td>

            <td class="p-1">
                <select data-field="parentesco" required class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer">
                    <option value="" disabled selected class="text-gray-400">Seleccione...</option>
                    <option value="Jefe/a">Jefe/a de Hogar</option>
                    <option value="Esposo/a">Esposo/a</option>
                    <option value="Conviviente">Conviviente</option>
                    <option value="Hijo/a">Hijo/a</option>
                    <option value="Hijastro/a">Hijastro/a</option>
                    <option value="Padre/Madre">Padre/Madre</option>
                    <option value="Hermano/a">Hermano/a</option>
                    <option value="Nieto/a">Nieto/a</option>
                    <option value="Yerno/Nuera">Yerno/Nuera</option>
                    <option value="Suegro/a">Suegro/a</option>
                    <option value="Abuelo/a">Abuelo/a</option>
                    <option value="Otro">Otro</option>
                </select>
            </td>

            <td class="p-1">
                <input type="text" data-field="edad" required maxlength="3" inputmode="numeric"
                    oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value) this.value = Math.max(0, Math.min(120, parseInt(this.value)))"
                    class="w-full bg-transparent border-b border-transparent focus:border-blue-500 focus:ring-0 text-[12px] md:text-sm text-center p-1" 
                    placeholder="0">
            </td>

            <td class="p-1">
                <select data-field="sexo" required class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer">>
                    <option value="" disabled selected class="text-gray-400">Seleccione...</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                </select>
            </td>

            <td class="p-1">
                <select data-field="ecivil" required class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer">>
                    <option value="" disabled selected>Seleccione...</option>
                    <option value="Soltero/a">Soltero/a</option>
                    <option value="Casado/a">Casado/a</option>
                    <option value="Conviviente">Conviviente</option>
                    <option value="Separado/a">Separado/a</option>
                    <option value="Divorciado/a">Divorciado/a</option>
                    <option value="Viudo/a">Viudo/a</option>
                </select>
            </td>

            <td class="p-1">
                <select data-field="neducativo" required class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer">>
                    <option value="" disabled selected>Seleccione...</option>
                    <option value="Sin Instrucci칩n">Sin Instrucci칩n</option>
                    <option value="Inicial">Inicial</option>
                    <option value="Primaria Incompleta">Primaria Incomp.</option>
                    <option value="Primaria Completa">Primaria Comp.</option>
                    <option value="Secundaria Incompleta">Secundaria Incomp.</option>
                    <option value="Secundaria Completa">Secundaria Comp.</option>
                    <option value="Superior T칠cnico">Sup. T칠cnico</option>
                    <option value="Superior Univ.">Sup. Universitario</option>
                </select>
            </td>

            <td class="p-1">
                <select data-field="ocupacion" required class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer">>
                    <option value="" disabled selected>Seleccione...</option>
                    <option value="Estudiante">Estudiante</option>
                    <option value="Ama de Casa">Ama de Casa</option>
                    <option value="Trabajador Independiente">Trab. Independiente</option>
                    <option value="Empleado Dependiente">Emp. Dependiente</option>
                    <option value="Comerciante">Comerciante</option>
                    <option value="Obrero/a">Obrero/a</option>
                    <option value="Agricultor/a">Agricultor/a</option>
                    <option value="Desempleado/a">Desempleado/a</option>
                    <option value="Jubilado/a">Jubilado/a</option>
                    <option value="Otro">Otro</option>
                </select>
            </td>

            <td class="p-1">
                <input type="number" data-field="ingresos" step="0.01" min="0" required
                    class="w-full bg-transparent border-b border-transparent focus:border-blue-500 focus:ring-0 text-[12px] md:text-sm text-right p-1" 
                    placeholder="0.00"
                    onkeydown="if(['-','+','e'].includes(event.key)) event.preventDefault();">
            </td>

            <td class="p-1 text-center">
                <button type="button" onclick="eliminarFila(this)" class="text-red-400 hover:text-red-600 font-bold px-2 text-[12px] md:text-lg transition-transform hover:scale-110" title="Eliminar fila">&times;</button>
            </td>
        `;

            tbody.appendChild(row);
            renumerarFilas(); // Actualiza IDs y nombres para el backend
        }

        function eliminarFila(btn) {
            const row = btn.closest('tr');
            if (row) {
                row.remove();
                renumerarFilas(); // Reordenamos todo
            }
        }

        function renumerarFilas() {
            const tbody = document.getElementById('familiares-body');
            const rows = tbody.querySelectorAll('tr');
            let contador = 0;

            rows.forEach((row, index) => {
                contador = index + 1;

                // Actualizar ID y N칰mero Visual
                row.id = `fam-${contador}`;
                const indexCell = row.querySelector('.index-cell');
                if (indexCell) indexCell.innerText = contador;

                // Actualizar names para Backend (Vital para Django)
                const inputs = row.querySelectorAll('[data-field]');
                inputs.forEach(input => {
                    const fieldName = input.getAttribute('data-field');
                    input.name = `fam_${contador}_${fieldName}`;
                });
            });

            // Actualizar input oculto total
            document.getElementById('total_familiares').value = contador;

            // Verificar estado del bot칩n Agregar
            const limite = parseInt(document.getElementById('input_num_integrantes').value) || 0;
            verificarTope(limite);

            // Actualizar contador global
            contadorFamiliares = contador;
        }
    </script>
    {% endblock %}