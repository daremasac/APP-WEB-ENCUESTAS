{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto pb-12">
    
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ titulo }}</h1>
            <p class="text-sm text-gray-500">Configura el enunciado y sus alternativas de respuesta.</p>
        </div>
        <a href="{% url back_url %}" class="text-gray-500 hover:text-gray-700 font-medium text-sm flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Volver al Banco
        </a>
    </div>

    <form method="POST" id="pregunta-form" class="space-y-8">
        {% csrf_token %}

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
            
            <h2 class="text-sm font-bold text-gray-800  tracking-wide mb-6 flex items-center gap-2">
                <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs">1</span>
                Definición de la Pregunta
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                <div class="md:col-span-8">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Dimensión / Categoría</label>
                    {{ form.dimension }}
                    {% if form.dimension.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.dimension.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-400 mt-1">Selecciona la categoría a la que pertenece este ítem.</p>
                </div>

                <div class="md:col-span-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">N° Orden</label>
                    <div class="relative">
                        {{ form.orden }}
                        <div id="orden-loading" class="absolute right-3 top-2.5 hidden">
                            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    {% if form.orden.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.orden.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-400 mt-1" id="orden-hint">Se calculará automáticamente.</p>
                </div>

                <div class="md:col-span-12">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Enunciado de la Pregunta</label>
                    {{ form.enunciado }}
                    {% if form.enunciado.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.enunciado.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">
            <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>

            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-sm font-bold text-gray-800  tracking-wide flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xs">2</span>
                    Alternativas y Puntajes
                </h2>
                <button type="button" id="add-option" class="group bg-white border border-gray-300 text-gray-700 hover:border-green-500 hover:text-green-600 px-4 py-2 rounded-lg text-xs font-bold transition-all shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400 group-hover:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Agregar Opción
                </button>
            </div>

            {{ formset.management_form }}

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-white text-gray-500 font-semibold border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-3 w-[65%]">Texto de la Opción</th>
                            <th class="px-6 py-3 w-[20%]">Puntaje</th>
                            <th class="px-6 py-3 w-[15%] text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="opciones-container" class="divide-y divide-gray-50">
                        {% for form_opcion in formset %}
                            <tr class="option-row group hover:bg-green-50/30 transition">
                                {% for hidden in form_opcion.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}

                                <td class="px-6 py-3 align-top">
                                    {{ form_opcion.texto }}
                                    {% if form_opcion.texto.errors %}
                                        <div class="text-red-500 text-xs mt-1">{{ form_opcion.texto.errors.0 }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-3 align-top">
                                    {{ form_opcion.puntaje }}
                                    {% if form_opcion.puntaje.errors %}
                                        <div class="text-red-500 text-xs mt-1">{{ form_opcion.puntaje.errors.0 }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-3 text-center align-middle">
                                    <div class="hidden">{{ form_opcion.DELETE }}</div>
                                    
                                    <button type="button" class="delete-btn text-gray-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition" title="Eliminar opción">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div id="empty-message" class="hidden p-10 text-center border-t border-gray-100">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 mb-3 text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
                </div>
                <p class="text-gray-500 text-sm">No hay opciones definidas para esta pregunta.</p>
                <p class="text-gray-400 text-xs mt-1">Haga clic en "Agregar Opción" para comenzar.</p>
            </div>
        </div>

        <div class="pt-6 border-t border-gray-200 flex items-center justify-end gap-3">
            <a href="{% url back_url %}" class="px-6 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-bold hover:bg-gray-50 transition text-sm">
                Cancelar
            </a>
            <button type="submit" class="px-8 py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg hover:shadow-blue-500/30 transition transform hover:-translate-y-0.5 text-sm">
                Guardar Pregunta
            </button>
        </div>
    </form>

    <table class="hidden">
        <tbody id="empty-form-template">
            <tr class="option-row group hover:bg-green-50/30 transition animate-fade-in-down">
                <td class="px-6 py-3 align-top">
                    {{ formset.empty_form.texto }}
                </td>
                <td class="px-6 py-3 align-top">
                    {{ formset.empty_form.puntaje }}
                </td>
                <td class="px-6 py-3 text-center align-middle">
                    <div class="hidden">{{ formset.empty_form.DELETE }}</div>
                    <button type="button" class="delete-btn text-gray-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

</div>

<script>
    // Recibimos los datos del backend
    const ultimosOrdenes = {{ ordenes_json|default:"{}"|safe }};

    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. LÓGICA DE ORDEN INTELIGENTE (CORREGIDA PARA EDICIÓN) ---
        const selectDimension = document.getElementById('id_dimension');
        const inputOrden = document.getElementById('id_orden');
        const hintOrden = document.getElementById('orden-hint');
        const loadingIcon = document.getElementById('orden-loading');

        // Guardamos la dimensión inicial para saber si el usuario la cambió
        let dimensionInicial = selectDimension ? selectDimension.value : null;

        if (selectDimension && inputOrden) {
            
            selectDimension.addEventListener('change', function() {
                const dimId = this.value;
                
                // Solo actuamos si hay una dimensión seleccionada
                if (dimId && ultimosOrdenes[dimId] !== undefined) {
                    
                    // Mostrar carga visual
                    loadingIcon.classList.remove('hidden');
                    
                    setTimeout(() => {
                        // Calcular el siguiente orden (Último + 1)
                        // NOTA: Si estamos en la misma dimensión original, no forzamos el cambio
                        // para respetar el orden que ya tenía, a menos que el usuario lo toque.
                        
                        const siguiente = ultimosOrdenes[dimId] + 1;
                        
                        // Actualizamos el valor
                        inputOrden.value = siguiente;
                        
                        // Feedback visual
                        hintOrden.textContent = `Nueva posición sugerida: ${siguiente} (Final de lista)`;
                        hintOrden.className = 'text-xs mt-1 text-blue-600 font-bold animate-pulse';
                        
                        inputOrden.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-300');
                        setTimeout(() => {
                            inputOrden.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-300');
                            loadingIcon.classList.add('hidden');
                        }, 600);
                        
                    }, 200);
                }
            });
        }

        // --- 2. LÓGICA DE FORMSET (Igual que antes) ---
        const container = document.getElementById('opciones-container');
        const addButton = document.getElementById('add-option');
        const totalFormsInput = document.getElementById('id_opciones-TOTAL_FORMS');
        const emptyTemplate = document.getElementById('empty-form-template').innerHTML;
        const emptyMessage = document.getElementById('empty-message');

        function checkEmptyState() {
            const visibleRows = container.querySelectorAll('tr:not([style*="display: none"])').length;
            if (visibleRows === 0) emptyMessage.classList.remove('hidden');
            else emptyMessage.classList.add('hidden');
        }

        checkEmptyState();

        if (addButton) {
            addButton.addEventListener('click', function() {
                const formIdx = totalFormsInput.value;
                const newRowHtml = emptyTemplate.replace(/__prefix__/g, formIdx);
                container.insertAdjacentHTML('beforeend', newRowHtml);
                totalFormsInput.value = parseInt(formIdx) + 1;
                checkEmptyState();
            });
        }

        container.addEventListener('click', function(e) {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;
            const row = btn.closest('tr');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = 'none';
            } else {
                row.remove();
            }
            checkEmptyState();
        });
    });
</script>
<style>
    /* Animación suave al agregar fila */
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-down {
        animation: fadeInDown 0.3s ease-out forwards;
    }
</style>
{% endblock %}