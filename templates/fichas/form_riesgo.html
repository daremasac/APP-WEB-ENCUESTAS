{% extends 'base.html' %}

{% block content %}
<style>
    /* Ocultar barra de scroll en tabs para est칠tica */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Animaci칩n suave entre pesta침as */
    .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilo de Inputs m치s profesional */
    .form-input {
        @apply w-full rounded-lg border-gray-300 bg-gray-50 px-4 py-3 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20 transition-all duration-200 outline-none;
    }

    /* Estilos espec칤ficos para la tabla responsiva */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
</style>

<div class="max-w-6xl mx-auto pb-32 px-4 sm:px-6">

    <div class="text-center mt-[25px] md:mt-0 pt-8 mb-6">
        <h1 class="text-xl md:text-3xl font-extrabold text-gray-900 tracking-tight">
            Evaluaci칩n de Riesgo Social
        </h1>
        <p class="text-[12px] md:text-sm text-gray-500 mt-2">Complete la informaci칩n solicitada en cada secci칩n.</p>
    </div>

    <div
        class="hidden lg:block sticky top-16 z-30 bg-gray-100/95 backdrop-blur-sm -mx-4 px-4 sm:mx-0 sm:px-0 mb-6 py-2 border-b border-gray-200/50">
        <div class="flex space-x-2 overflow-x-auto scrollbar-hide snap-x" id="tabs-container">
            <button type="button"
                class=" tab-btn active snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-blue-600 text-white shadow-md transition-all duration-200 flex-shrink-0"
                data-index="0">
                Datos Generales
            </button>
            <button type="button"
                class="up tab-btn snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:text-gray-900 transition-all duration-200 flex-shrink-0"
                data-index="1">
                Estructura Familiar
            </button>

            {% for dim in dimensiones %}
            <button type="button"
                class="tab-btn snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:text-gray-900 transition-all duration-200 flex-shrink-0"
                data-index="{{ forloop.counter|add:1 }}">
                {{ dim.nombre }}
            </button>
            {% endfor %}
            <!-- Agregado -->
            <button type="button" id="tab-btn-resultados"
                class="tab-btn snap-start whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 transition-all duration-200 flex-shrink-0"
                data-index="ultimo">
                Resultados y Validaci칩n
            </button>
            <!-- end agreagdo -->
        </div>
    </div>


    <form method="POST" id="form-riesgo" class="relative">
        {% csrf_token %}

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[500px]">

            <div class="tab-pane fade-in p-6 md:p-8 block" data-step="0">
                <div class="mb-8 border-l-4 border-blue-500 pl-4">
                    <h2 class="text-[14px] md:text-xl font-bold text-gray-800">Datos Generales del Profesional</h2>
                    <p class="text-[12px] md:text-sm text-gray-400">Detalle del profesional</p>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Nombres:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="text" name="nombres_encuestado" required class="form-input "
                                placeholder="Ingrese apellidos y nombres completos">
                        </div>
                        <div>
                            <label
                                class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Apellidos:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="text" name="apellidos_encuestado" required class="form-input "
                                placeholder="Ingrese apellidos y nombres completos">
                        </div>

                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Edad:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="number" name="edad" required class="form-input" placeholder="Ej: 15">
                        </div>
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Fecha de
                                Nacimiento:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="date" name="fecha_nacimiento" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">DNI:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="text" name="dni" required maxlength="8" class="form-input" placeholder="DNI">
                        </div>
                    </div>

                    <div
                        class="grid grid-cols-1 md:grid-cols-12 gap-6 bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="md:col-span-4">
                            <label class="block  text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Sexo:</label>
                            <div class="radio-group mt-2">
                                <label class="radio-label mr-4 text-[12px] md:text-sm">
                                    <input type="radio" class=" " name="sexo" value="M" required> Masculino
                                </label>
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="sexo" value="F" class="radio-input "> Femenino
                                </label>
                            </div>
                        </div>
                        <div class="md:col-span-8">
                            <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Nivel
                                Educativo:</label>
                            <div class="radio-group mt-2">
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="nivel_educativo" required value="Primaria"
                                        class="radio-input ">
                                    Primaria
                                </label>
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="nivel_educativo" value="Secundaria" class="radio-input ">
                                    Secundaria
                                </label>
                                <label class="radio-label text-[12px] md:text-sm mr-4">
                                    <input type="radio" name="nivel_educativo" value="Universidad" class="radio-input ">
                                    Universidad
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label
                                class="form-label font-bold text-gray-700 mb-1 block  text-[12px] md:text-sm">Departamento
                                (Actual)</label>
                            <select name="ubigeo_departamento" id="cbo_dep_actual"
                                class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none"
                                onchange="cargarProvincias('actual')" required>
                                <option value="">-- Seleccione --</option>
                                {% for d in departamentos %}
                                <option value="{{ d.id }}">{{ d.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label
                                class="form-label font-bold text-gray-700 mb-1 block text-[12px] md:text-sm">Provincia
                                (Actual)</label>
                            <select name="ubigeo_provincia" id="cbo_prov_actual"
                                class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none"
                                onchange="cargarDistritos('actual')" required disabled>
                                <option value="">-- Primero Dpto --</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label font-bold text-gray-700 mb-1 block text-[12px] md:text-sm">Distrito
                                (Actual)</label>
                            <select name="ubigeo_distrito" id="cbo_dist_actual"
                                class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none"
                               required disabled>
                                <option value="">-- Primero Prov --</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Direcci칩n
                            Actual:</label>
                        <input
                            class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                            type="text" name="direccion" required class="form-input"
                            placeholder="Av./Calle, N칰mero/Interior">
                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Tel칠fono de
                                contacto:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="tel" name="telefono" required>
                        </div>
                        <div><label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Email:</label>
                            <input
                                class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                type="email" name="email" required>
                        </div>
                    </div>

                    <div class="bg-blue-50/50 p-6 rounded-xl border border-blue-100 mt-4">
                        <label class="text-blue-800 font-bold mb-4 block border-b border-blue-100 pb-2">En caso de
                            emergencia contactar a:</label>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <label class="text-[12px] md:text-sm font-semibold text-gray-500  ">Nombre
                                    Completo</label>
                                <input type="text" name="emergencia_contacto"
                                    class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                    required>
                            </div>
                            <div>
                                <label
                                    class="text-[12px] md:text-sm font-semibold text-gray-500 ">Tel칠fono</label>
                                <input type="text" name="emergencia_telefono"
                                    class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
                                    required>
                            </div>
                            <div>

                                <label
                                    class="text-[12px] md:text-sm font-semibold text-gray-500 ">Parentesco</label>
                                <select name="emergencia_parentesco" required
                                    class="w-full text-[12px] md:text-sm rounded-lg border border-gray-300 bg-gray-50 px-3  py-2 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 appearance-none cursor-pointer outline-none">
                                    <option value="">Seleccione parentesco...</option>
                                    <option value="Padre">Padre</option>
                                    <option value="Madre">Madre</option>
                                    <option value="Hijo">Hijo</option>
                                    <option value="Hija">Hija</option>
                                    <option value="Hermano">Hermano</option>
                                    <option value="Hermana">Hermana</option>
                                    <option value="Abuelo">Abuelo</option>
                                    <option value="Abuela">Abuela</option>
                                    <option value="T칤o">T칤o</option>
                                    <option value="T칤a">T칤a</option>
                                    <option value="Primo">Primo</option>
                                    <option value="Prima">Prima</option>
                                    <option value="Esposo">Esposo</option>
                                    <option value="Esposa">Esposa</option>
                                    <option value="Pareja">Pareja</option>
                                    <option value="Suegro">Suegro</option>
                                    <option value="Suegra">Suegra</option>
                                    <option value="Cu침ado">Cu침ado</option>
                                    <option value="Cu침ada">Cu침ada</option>
                                    <option value="Yerno">Yerno</option>
                                    <option value="Nuera">Nuera</option>
                                    <option value="Amigo">Amigo</option>
                                    <option value="Amiga">Amiga</option>
                                    <option value="Vecino">Vecino</option>
                                    <option value="Vecina">Vecina</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="tab-pane fade-in p-6 md:p-8 hidden" data-step="1">
                <div class="mb-8 border-l-4 border-blue-500 pl-4">
                    <h2 class="text-[14px] md:text-xl font-bold text-gray-800">Estructura Familiar</h2>
                    <p class="text-[12px] md:text-sm text-gray-400">Detalle de los miembros del hogar</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Jefe de Hogar</label>
                        <input type="text" name="jefe_hogar"
                            oninput="this.value = this.value.replace(/[^a-zA-Z치칠칤칩칰츼칄칈칍칔침칌\s]/g, '')"
                            class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 "
                            placeholder="Nombre del jefe/a" required>
                    </div>
                    <div>
                        <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">N칰mero total de
                            integrantes</label>
                        <input type="number" name="num_integrantes" id="input_num_integrantes" min="0"
                            class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-3 md:px-4 py-2 md:py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20 "
                            placeholder="Ej: 3" required onfocus="this.dataset.valorPrevio = this.value"
                            oninput="controlarLimiteFamilia(this)">
                    </div>
                </div>

                <div id="tabla-container-familia"
                    class="table-container border border-gray-200 mb-4 hidden transition-all duration-300">
                    <table class="w-full text-[12px] md:text-sm text-left min-w-[1000px]">
                        <thead class="text-xs text-white  bg-blue-600">
                            <tr>
                                <th class="px-3 py-4 w-10 text-center">#</th>
                                <th class="px-3 py-4 min-w-[180px]">Nombres y Apellidos</th>
                                <th class="px-3 py-4 w-32">Parentesco</th>
                                <th class="px-3 py-4 w-20">Edad</th>
                                <th class="px-3 py-4 w-24">Sexo</th>
                                <th class="px-3 py-4 w-32">Est. Civil</th>
                                <th class="px-3 py-4 w-32">Nivel Edu.</th>
                                <th class="px-3 py-4 w-32">Ocupaci칩n</th>
                                <th class="px-3 py-4 w-28">Ingresos</th>
                                <th class="px-3 py-4 w-12"></th>
                            </tr>
                        </thead>
                        <tbody id="familiares-body" class=" text-[12px] md:text-sm divide-y divide-gray-100 bg-white">
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end mb-6">
                    <button type="button" id="btn-add-familiar" onclick="agregarFilaFamiliar()"
                        class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold transition-colors border border-blue-200 disabled:opacity-50 disabled:cursor-not-allowed hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Agregar Integrante
                    </button>
                </div>

                <input type="hidden" name="total_familiares" id="total_familiares" value="0">

                <div class="mt-6">
                    <label class="block text-[12px] md:text-sm font-bold text-gray-700 mb-1.5">Observaciones</label>
                    <textarea name="observaciones_familia" rows="3"
                        class="w-full text-[12px] md:text-sm rounded-lg border-gray-300 bg-gray-50 px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-500/20"></textarea>
                </div>
            </div>


            {% for dim in dimensiones %}
            <div class="tab-pane fade-in p-6 md:p-8 hidden" data-step="{{ forloop.counter|add:1 }}">
                <div class="mb-8 border-l-4 border-blue-500 pl-4">
                    <h2 class="text-xl font-bold text-gray-800">{{ dim.nombre }}</h2>
                    <p class="text-sm text-gray-400 italic">{{ dim.descripcion }}</p>
                </div>

                <div class="space-y-5">
                    {% for pregunta in dim.preguntas.all %}
                    <div
                        class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm hover:border-blue-300 hover:shadow-md transition-all duration-200">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-shrink-0">
                                <span
                                    class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-bold text-sm shadow-sm">
                                    {{ pregunta.orden }}
                                </span>
                            </div>

                            <div class="flex-grow">
                                <label
                                    class="block text-gray-800 font-medium mb-3 text-sm md:text-base leading-relaxed">
                                    {{ pregunta.enunciado }}
                                </label>

                                <div class="relative">
                                    <select name="pregunta_{{ pregunta.id }}" required
                                        class="block w-full appearance-none rounded-lg border border-gray-300 bg-gray-50 py-3 px-4 pr-10 leading-tight text-gray-700 focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors cursor-pointer">
                                        <option value="">Seleccione una opci칩n...</option>
                                        {% for opcion in pregunta.opciones.all %}
                                        <option value="{{ opcion.id }}" data-pts="{{ opcion.puntaje }}">
                                            {{ opcion.texto }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                        <svg class="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            <!-- agregado -->
            <div class="tab-pane fade-in p-6 md:p-8 hidden" data-step="ultimo" id="panel-resultados">
                <div class="mb-8 border-l-4 border-green-500 pl-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">C치lculo de Puntuaci칩n y Resultado de Riesgo
                        Social</h2>
                    <p class="text-sm text-gray-500">Revise el desglose t칠cnico antes de finalizar el registro.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                    <div class="lg:col-span-2">
                        <h3 class="text-sm font-bold text-blue-600  mb-4 tracking-wider">Puntuaci칩n por
                            Dimensi칩n</h3>
                        <div class="table-container border border-gray-200">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-600 border-b border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 font-semibold">Dimensi칩n</th>
                                        <th class="px-4 py-3 text-center font-semibold">Puntuaci칩n Obtenida</th>
                                        <th class="px-4 py-3 text-center font-semibold">M치ximo Te칩rico</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-puntuaciones-body" class="divide-y divide-gray-100">
                                </tbody>
                                <tfoot class="bg-gray-50 font-bold text-gray-900 border-t-2 border-gray-200">
                                    <tr>
                                        <td class="px-4 py-3 text-right  text-xs">Puntuaci칩n Total de Riesgo
                                        </td>
                                        <td class="px-4 py-3 text-center text-lg" id="res-puntaje-final-tabla">0</td>
                                        <td class="px-4 py-3 text-center text-gray-400">125 (M치x.)</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <h3 class="text-sm font-bold text-blue-600  mb-4 tracking-wider">Nivel de Riesgo
                            General</h3>
                        <div
                            class="bg-white border-2 border-gray-100 rounded-3xl p-8 shadow-sm flex flex-col items-center justify-center flex-grow text-center">
                            <p class="text-xs text-gray-400  font-bold tracking-widest mb-2">Puntuaci칩n Final
                            </p>
                            <div class="text-6xl font-black text-gray-800 mb-6" id="res-puntaje-big">0</div>
                            <div id="res-badge-grande"
                                class="w-full py-4 rounded-2xl text-xl font-black shadow-md transition-all duration-500">
                                --
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-10">
                    <h3 class="text-sm font-bold text-blue-600  mb-4 tracking-wider">Interpretaci칩n por
                        Dimensi칩n</h3>
                    <div id="grid-interpretacion" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>

                <div class="mt-8 border-t border-gray-200 pt-8">
                    <h3 class="text-sm font-bold text-gray-700  mb-4 tracking-wider text-center">Escala de
                        Semaforizaci칩n</h3>
                    <div class="grid grid-cols-1 gap-2 overflow-hidden rounded-xl border border-gray-100">
                        <div class="grid grid-cols-12 bg-red-600 text-white p-3 items-center">
                            <div class="col-span-3 font-bold text-xs ">Riesgo Cr칤tico</div>
                            <div class="col-span-2 text-center text-xs font-bold">126 o m치s</div>
                            <div class="col-span-7 text-[11px] leading-tight pl-4">Activaci칩n inmediata del Protocolo de
                                Emergencia.</div>
                        </div>
                        <div class="grid grid-cols-12 bg-orange-500 text-white p-3 items-center">
                            <div class="col-span-3 font-bold text-xs ">Riesgo Severo</div>
                            <div class="col-span-2 text-center text-xs font-bold">76 - 125</div>
                            <div class="col-span-7 text-[11px] leading-tight pl-4">Derivaci칩n a servicios especializados
                                con seguimiento intensivo.</div>
                        </div>
                        <div class="grid grid-cols-12 bg-yellow-400 text-gray-900 p-3 items-center">
                            <div class="col-span-3 font-bold text-xs ">Riesgo Moderado</div>
                            <div class="col-span-2 text-center text-xs font-bold">26 - 75</div>
                            <div class="col-span-7 text-[11px] leading-tight pl-4">Consejer칤a y apoyo socioemocional,
                                Plan de mejora de factores de riesgo.</div>
                        </div>
                        <div class="grid grid-cols-12 bg-green-500 text-white p-3 items-center">
                            <div class="col-span-3 font-bold text-xs ">Riesgo Bajo</div>
                            <div class="col-span-2 text-center text-xs font-bold">0 - 25</div>
                            <div class="col-span-7 text-[11px] leading-tight pl-4">Monitoreo preventivo, Fortalecimiento
                                de factores protectores.</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end agreagdo -->
        </div>


        <div
            class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40">
            <div class="max-w-5xl mx-auto flex justify-between items-center gap-4">
                <button type="button" onclick="confirmarSalida()"
                    class="px-4 py-3 rounded-xl border border-red-200 text-red-600 font-bold hover:bg-red-50 transition w-full sm:w-auto flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                    <span class=" sm:inline">Salir</span>
                </button>

                <button type="button" id="btn-prev"
                    class="px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 active:scale-95 transition hidden w-full sm:w-auto">
                    Anterior
                </button>

                <div class="hidden sm:block text-xs font-semibold text-gray-400  tracking-widest">
                    Secci칩n <span id="current-step-display">1</span> / <span id="total-steps-display">X</span>
                </div>

                <button type="button" id="btn-next"
                    class="px-8 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 hover:shadow-blue-500/30 active:scale-95 transition w-full sm:w-auto">
                    Siguiente
                </button>

                <button type="submit" id="btn-submit"
                    class="hidden px-8 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg hover:bg-green-700 hover:shadow-green-500/30 active:scale-95 transition w-full sm:w-auto">
                    Finalizar y Guardar
                </button>
            </div>
        </div>

    </form>
    <script>
        // ============================================================================
        // FORMULARIO DE EVALUACI칍N DE RIESGO SOCIAL - JAVASCRIPT CORREGIDO
        // ============================================================================

        // --- VARIABLES GLOBALES ---
        let currentStep = 0;
        let formularioSucio = false;

        // --- PROTECCI칍N CONTRA SALIDA ACCIDENTAL ---
        function confirmarSalida() {
            const urlDestino = document.querySelector('[data-url-salida]')?.dataset.urlSalida || '/';

            if (formularioSucio) {
                const confirmar = confirm(
                    "丘멆잺 ATENCI칍N: Hay datos sin guardar.\n\n" +
                    "Si sale ahora, perder치 el progreso de esta ficha.\n\n" +
                    "쮼st치 seguro que desea salir?"
                );
                if (confirmar) {
                    formularioSucio = false;
                    window.location.href = urlDestino;
                }
            } else {
                window.location.href = urlDestino;
            }
        }

        // Protecci칩n antes de cerrar/recargar p치gina
        window.addEventListener('beforeunload', function (e) {
            if (formularioSucio) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // ============================================================================
        // INICIALIZACI칍N DEL FORMULARIO
        // ============================================================================
        document.addEventListener("DOMContentLoaded", function () {
            // Elementos del DOM
            const steps = document.querySelectorAll(".tab-pane");
            const tabButtons = document.querySelectorAll(".tab-btn");
            const btnNext = document.getElementById("btn-next");
            const btnPrev = document.getElementById("btn-prev");
            const btnSubmit = document.getElementById("btn-submit");
            const form = document.getElementById('form-riesgo');
            const totalSteps = steps.length;

            // Validar que existan los elementos necesarios
            if (!steps.length || !form) {
                console.error("Error: No se encontraron elementos requeridos del formulario");
                return;
            }

            // Actualizar contador de pasos
            const totalStepsDisplay = document.getElementById("total-steps-display");
            if (totalStepsDisplay) {
                totalStepsDisplay.innerText = totalSteps;
            }

            // ========================================================================
            // FUNCI칍N: MOSTRAR PASO
            // ========================================================================
            function showStep(index) {
                // Validar 칤ndice
                if (index < 0 || index >= totalSteps) {
                    console.warn(`칈ndice de paso inv치lido: ${index}`);
                    return;
                }

                // Si es el paso de resultados, actualizar c치lculos
                const currentPane = steps[index];
                if (currentPane && currentPane.id === "panel-resultados") {
                    actualizarResumenResultados();
                }

                // Ocultar todos los pasos y mostrar el actual
                steps.forEach((pane, idx) => {
                    if (pane) {
                        pane.classList.toggle("hidden", idx !== index);
                        pane.classList.toggle("block", idx === index);
                    }
                });

                // Actualizar estado de los botones de tabs
                tabButtons.forEach((btn, idx) => {
                    if (btn) {
                        const isActive = (idx === index);
                        btn.classList.toggle("bg-blue-600", isActive);
                        btn.classList.toggle("text-white", isActive);
                        btn.classList.toggle("shadow-md", isActive);
                        btn.classList.toggle("bg-white", !isActive);
                        btn.classList.toggle("text-gray-600", !isActive);

                        // Scroll al tab activo (solo en desktop)
                        if (isActive && window.innerWidth >= 1024) {
                            btn.scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest',
                                inline: 'center'
                            });
                        }
                    }
                });

                // Actualizar paso actual
                currentStep = index;

                // Visibilidad de botones de navegaci칩n
                if (btnPrev) btnPrev.classList.toggle("hidden", currentStep === 0);

                if (currentStep === totalSteps - 1) {
                    if (btnNext) btnNext.classList.add("hidden");
                    if (btnSubmit) btnSubmit.classList.remove("hidden");
                } else {
                    if (btnNext) btnNext.classList.remove("hidden");
                    if (btnSubmit) btnSubmit.classList.add("hidden");
                }

                // Actualizar indicador de paso
                const currentStepDisplay = document.getElementById("current-step-display");
                if (currentStepDisplay) {
                    currentStepDisplay.innerText = currentStep + 1;
                }

                // Scroll suave al inicio
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // ========================================================================
            // FUNCI칍N: VALIDAR PASO ACTUAL
            // ========================================================================
            function validarPasoActual() {
                const currentPanel = steps[currentStep];
                if (!currentPanel) return false;

                let esValido = true;
                let primerError = null;

                // --- VALIDACI칍N ESPECIAL: TABLA DE FAMILIARES (Paso 1) ---
                if (currentStep === 1) {
                    const inputTotal = document.getElementById('input_num_integrantes');
                    const totalEsperado = parseInt(inputTotal?.value) || 0;
                    const famBody = document.getElementById('familiares-body');
                    const filasReales = famBody ? famBody.querySelectorAll('tr').length : 0;

                    if (totalEsperado <= 0) {
                        alert("丘멆잺 Por favor, ingrese el n칰mero de integrantes (m칤nimo 1).");
                        if (inputTotal) inputTotal.focus();
                        return false;
                    }

                    if (totalEsperado !== filasReales) {
                        alert(
                            `游띔 Error de Validaci칩n:\n\n` +
                            `Ha indicado ${totalEsperado} integrante(s) pero la tabla tiene ${filasReales} fila(s).\n\n` +
                            `Por favor, ajuste el n칰mero o complete/elimine filas.`
                        );
                        return false;
                    }

                    // Validar que todas las filas est칠n completas
                    const filas = famBody.querySelectorAll('tr');
                    for (let i = 0; i < filas.length; i++) {
                        const fila = filas[i];
                        const inputs = fila.querySelectorAll('input[required], select[required]');

                        for (let input of inputs) {
                            if (!input.value || input.value.trim() === '') {
                                alert(`丘멆잺 Por favor, complete todos los campos del integrante #${i + 1}`);
                                input.focus();
                                input.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                                setTimeout(() => {
                                    input.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                                }, 2000);
                                return false;
                            }
                        }
                    }
                }

                // --- VALIDACI칍N GENERAL: CAMPOS REQUERIDOS ---
                const inputs = currentPanel.querySelectorAll("input[required], select[required], textarea[required]");

                inputs.forEach(input => {
                    // Solo validar elementos visibles
                    if (input.offsetParent !== null) {
                        let valorValido = false;

                        if (input.type === 'radio') {
                            // Validar grupo de radios
                            const grupoRadios = document.getElementsByName(input.name);
                            valorValido = Array.from(grupoRadios).some(r => r.checked);
                        } else if (input.type === 'checkbox') {
                            valorValido = input.checked;
                        } else {
                            valorValido = input.value && input.value.trim() !== '';
                        }

                        if (!valorValido) {
                            esValido = false;
                            input.classList.add('border-red-500', 'ring-2', 'ring-red-100');
                            if (!primerError) primerError = input;
                        } else {
                            input.classList.remove('border-red-500', 'ring-2', 'ring-red-100');
                        }
                    }
                });

                // Mostrar mensaje y hacer focus al primer error
                if (!esValido && primerError) {
                    alert("丘멆잺 Por favor, complete todos los campos obligatorios antes de continuar.");
                    primerError.focus();
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                return esValido;
            }

            // ========================================================================
            // FUNCI칍N: ACTUALIZAR RESUMEN DE RESULTADOS
            // ========================================================================
            function actualizarResumenResultados() {
                let puntajeTotalGlobal = 0;
                const tablaBody = document.getElementById('tabla-puntuaciones-body');
                const gridInterpretacion = document.getElementById('grid-interpretacion');

                if (tablaBody) tablaBody.innerHTML = '';
                if (gridInterpretacion) gridInterpretacion.innerHTML = '';

                steps.forEach((pane, idx) => {
                    const stepId = pane.getAttribute('data-step');

                    // Omitir pasos que no son dimensiones (Datos Generales, Familia, Resultados)
                    if (["0", "1", "ultimo"].includes(stepId)) return;

                    const tituloDim = pane.querySelector('h2')?.innerText.trim() || `Dimensi칩n ${idx}`;
                    let subtotalObtenido = 0;
                    let maximoTeoricoDimension = 0;

                    // Obtener todas las preguntas (selects) de esta dimensi칩n
                    const preguntasSelect = pane.querySelectorAll('select[name^="pregunta_"]');

                    preguntasSelect.forEach(sel => {
                        // 1. Sumar puntaje de la opci칩n seleccionada por el usuario
                        if (sel.selectedIndex > 0) {
                            subtotalObtenido += parseInt(sel.options[sel.selectedIndex].getAttribute('data-pts')) || 0;
                        }

                        // 2. CALCULAR M츼XIMO TE칍RICO: Solo el valor m치s alto entre las opciones de esta pregunta
                        let puntajeMasAltoPregunta = 0;
                        Array.from(sel.options).forEach(opt => {
                            const pts = parseInt(opt.getAttribute('data-pts')) || 0;
                            if (pts > puntajeMasAltoPregunta) {
                                puntajeMasAltoPregunta = pts;
                            }
                        });
                        // Sumamos el tope de la pregunta al total de la dimensi칩n
                        maximoTeoricoDimension += puntajeMasAltoPregunta;
                    });

                    puntajeTotalGlobal += subtotalObtenido;

                    // 3. Generar Fila de Tabla (Clicable para editar)
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-100 group";
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-gray-700 font-medium group-hover:text-blue-600">${tituloDim}</td>
                        <td class="px-4 py-3 text-center font-bold text-blue-600">${subtotalObtenido}</td>
                        <td class="px-4 py-3 text-center text-gray-400 font-semibold">${maximoTeoricoDimension}</td>
                    `;
                    tr.onclick = () => showStep(idx);
                    if (tablaBody) tablaBody.appendChild(tr);

                    // 4. Generar Cuadro de Interpretaci칩n (Clicable para editar)
                    const card = document.createElement('div');
                    card.className = "p-4 rounded-xl bg-white border border-gray-200 cursor-pointer hover:border-blue-400 hover:shadow-md transition-all";
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-bold text-gray-400 ">${tituloDim}</p>
                            <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">Editar</span>
                        </div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xl font-black text-blue-700">${subtotalObtenido}</span>
                            <span class="text-xs text-gray-400">/ ${maximoTeoricoDimension} m치x.</span>
                        </div>
                    `;
                    card.onclick = () => showStep(idx);
                    if (gridInterpretacion) gridInterpretacion.appendChild(card);
                });

                // Actualizar los indicadores de puntaje y el sem치foro visual
                actualizarIndicadoresFinales(puntajeTotalGlobal);
            }
            function actualizarIndicadoresFinales(total) {
                const resPuntajeTabla = document.getElementById('res-puntaje-final-tabla');
                const resPuntajeBig = document.getElementById('res-puntaje-big');
                const badge = document.getElementById('res-badge-grande');

                if (resPuntajeTabla) resPuntajeTabla.innerText = total;
                if (resPuntajeBig) resPuntajeBig.innerText = total;

                if (badge) {
                    let config = { texto: "RIESGO BAJO", clases: "bg-green-500 text-white" };
                    if (total >= 126) config = { texto: "RIESGO CR칈TICO", clases: "bg-red-600 text-white" };
                    else if (total >= 76) config = { texto: "RIESGO SEVERO", clases: "bg-orange-500 text-white" };
                    else if (total >= 26) config = { texto: "RIESGO MODERADO", clases: "bg-yellow-400 text-gray-800" };

                    badge.innerText = config.texto;
                    badge.className = `w-full py-4 rounded-2xl text-xl font-black shadow-lg transition-all duration-500 flex items-center justify-center ${config.clases}`;
                }
            }
            // ========================================================================
            // EVENTOS DE NAVEGACI칍N
            // ========================================================================

            // Bot칩n "Siguiente"
            if (btnNext) {
                btnNext.addEventListener("click", () => {
                    if (validarPasoActual()) {
                        showStep(currentStep + 1);
                    }
                });
            }

            // Bot칩n "Anterior"
            if (btnPrev) {
                btnPrev.addEventListener("click", () => {
                    if (currentStep > 0) {
                        showStep(currentStep - 1);
                    }
                });
            }

            // Tabs de navegaci칩n
            tabButtons.forEach((btn, idx) => {
                btn.addEventListener("click", function () {
                    // Permitir retroceso sin validaci칩n
                    if (idx < currentStep) {
                        showStep(idx);
                        return;
                    }

                    // Para avanzar, validar
                    if (idx > currentStep) {
                        // Evitar saltos grandes
                        if (idx > currentStep + 1) {
                            alert("游뛂 Por favor, avance en orden secuencial completando cada secci칩n.");
                            return;
                        }

                        // Validar antes de avanzar
                        if (validarPasoActual()) {
                            showStep(idx);
                        }
                    }
                });
            });

            // ========================================================================
            // DETECTAR CAMBIOS PARA PROTECCI칍N DE SALIDA
            // ========================================================================
            if (form) {
                form.addEventListener('change', () => {
                    formularioSucio = true;
                });

                form.addEventListener('input', () => {
                    formularioSucio = true;
                });

                form.addEventListener('submit', (e) => {
                    // 1. Validamos que el 칰ltimo paso (Resultados) sea correcto
                    if (!validarPasoActual()) {
                        e.preventDefault();
                        return false;
                    }

                    // 2. Alerta de confirmaci칩n final
                    const mensaje = "쮼st치 seguro de que desea finalizar la evaluaci칩n?\n\n" +
                        "Una vez guardado, los datos ser치n registrados en el sistema.";

                    if (!confirm(mensaje)) {
                        e.preventDefault(); // Si el usuario cancela, no se env칤a
                        return false;
                    }

                    // 3. Feedback visual (Opcional pero recomendado)
                    const btnSubmit = document.getElementById("btn-submit");
                    if (btnSubmit) {
                        btnSubmit.disabled = true;
                        btnSubmit.innerHTML = `
                    <svg class="animate-spin h-5 w-5 mr-3 inline text-white" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Guardando...
                `;
                    }

                    // 4. Liberamos la protecci칩n de salida accidental
                    formularioSucio = false;
                    return true;
                });
            }

            // ========================================================================
            // INICIALIZAR PRIMER PASO
            // ========================================================================
            showStep(0);

            // console.log("九 Formulario de Evaluaci칩n de Riesgo inicializado correctamente");
        });

        // ============================================================================
        // FUNCIONES DE UBIGEO (CASCADA DEPARTAMENTO > PROVINCIA > DISTRITO)
        // ============================================================================

        function cargarProvincias(tipo) {
            const depSelect = document.getElementById(`cbo_dep_${tipo}`);
            const provSelect = document.getElementById(`cbo_prov_${tipo}`);
            const distSelect = document.getElementById(`cbo_dist_${tipo}`);

            if (!depSelect || !provSelect) return;

            const depId = depSelect.value;

            // Resetear select de provincias
            provSelect.innerHTML = '<option value="">Cargando...</option>';
            provSelect.disabled = true;

            // Resetear y deshabilitar distritos
            if (distSelect) {
                distSelect.innerHTML = '<option value="">-- Primero seleccione provincia --</option>';
                distSelect.disabled = true;
            }

            if (!depId) {
                provSelect.innerHTML = '<option value="">-- Primero seleccione departamento --</option>';
                return;
            }

            // Realizar petici칩n AJAX
            fetch(`/ubigeo/api/provincias/?dep_id=${depId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error en la petici칩n');
                    return response.json();
                })
                .then(data => {
                    let html = '<option value="">-- Seleccione Provincia --</option>';
                    data.forEach(provincia => {
                        html += `<option value="${provincia.id}">${provincia.nombre}</option>`;
                    });
                    provSelect.innerHTML = html;
                    provSelect.disabled = false;
                })
                .catch(error => {
                    // console.error('Error al cargar provincias:', error);
                    provSelect.innerHTML = '<option value="">Error al cargar datos</option>';
                    alert('丘멆잺 Error al cargar las provincias. Por favor, recargue la p치gina.');
                });
        }

        function cargarDistritos(tipo) {
            const provSelect = document.getElementById(`cbo_prov_${tipo}`);
            const distSelect = document.getElementById(`cbo_dist_${tipo}`);

            if (!provSelect || !distSelect) return;

            const provId = provSelect.value;

            // Resetear select de distritos
            distSelect.innerHTML = '<option value="">Cargando...</option>';
            distSelect.disabled = true;

            if (!provId) {
                distSelect.innerHTML = '<option value="">-- Primero seleccione provincia --</option>';
                return;
            }

            // Realizar petici칩n AJAX
            fetch(`/ubigeo/api/distritos/?prov_id=${provId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error en la petici칩n');
                    return response.json();
                })
                .then(data => {
                    let html = '<option value="">-- Seleccione Distrito --</option>';
                    data.forEach(distrito => {
                        html += `<option value="${distrito.id}">${distrito.nombre}</option>`;
                    });
                    distSelect.innerHTML = html;
                    distSelect.disabled = false;
                })
                .catch(error => {
                    // console.error('Error al cargar distritos:', error);
                    distSelect.innerHTML = '<option value="">Error al cargar datos</option>';
                    alert('丘멆잺 Error al cargar los distritos. Por favor, recargue la p치gina.');
                });
        }

        // ============================================================================
        // FUNCIONES DE GESTI칍N DE TABLA FAMILIAR
        // ============================================================================

        function controlarLimiteFamilia(input) {
            const limite = parseInt(input.value) || 0;
            const container = document.getElementById('tabla-container-familia');
            const btn = document.getElementById('btn-add-familiar');
            const tbody = document.getElementById('familiares-body');

            if (!tbody || !container || !btn) return;

            const filasActuales = tbody.querySelectorAll('tr').length;

            // Si se reduce el n칰mero y hay m치s filas de las permitidas
            if (limite < filasActuales) {
                const confirmar = confirm(
                    `丘멆잺 ATENCI칍N:\n\n` +
                    `Al reducir el n칰mero a ${limite}, se eliminar치n los 칰ltimos ${filasActuales - limite} registro(s).\n\n` +
                    `쮻esea continuar?`
                );

                if (!confirmar) {
                    // Restaurar valor anterior
                    input.value = input.dataset.valorPrevio || filasActuales;
                    return;
                }

                // Eliminar filas excedentes
                while (tbody.querySelectorAll('tr').length > limite) {
                    const ultimaFila = tbody.lastElementChild;
                    if (ultimaFila) ultimaFila.remove();
                }
            }

            // Mostrar/ocultar tabla y bot칩n seg칰n el l칤mite
            container.classList.toggle('hidden', limite === 0);
            btn.classList.toggle('hidden', limite === 0);
            btn.disabled = (limite === 0);

            // Guardar valor actual
            input.dataset.valorPrevio = limite;

            // Renumerar filas
            renumerarFilas();
        }

        function agregarFilaFamiliar() {
            const inputNum = document.getElementById('input_num_integrantes');
            const tbody = document.getElementById('familiares-body');

            if (!inputNum || !tbody) return;

            const limite = parseInt(inputNum.value) || 0;
            const filasActuales = tbody.querySelectorAll('tr').length;

            // Validaci칩n: no exceder el l칤mite
            if (filasActuales >= limite) {
                inputNum.focus();
                inputNum.classList.add('ring-4', 'ring-red-300', 'border-red-500');

                setTimeout(() => {
                    inputNum.classList.remove('ring-4', 'ring-red-300', 'border-red-500');
                }, 1000);

                alert(`丘멆잺 Ya alcanz칩 el l칤mite de ${limite} integrante(s).\n\nAumente el n칰mero total si desea agregar m치s.`);
                return;
            }

            // Crear nueva fila
            const row = document.createElement('tr');
            row.className = "hover:bg-blue-50 transition-colors group";

            row.innerHTML = `
        <td class="px-3 py-2 text-center text-gray-400 font-bold index-cell"></td>
        
        <td class="p-1">
            <input type="text" data-field="nombre" required
                oninput="this.value = this.value.replace(/[^a-zA-Z치칠칤칩칰츼칄칈칍칔침칌\\s]/g, '')"
                class="w-full text-sm bg-transparent border-b border-gray-200 focus:border-blue-500 focus:ring-0  p-2 placeholder-gray-400 outline-none" 
                placeholder="Nombres y Apellidos">
        </td>

        <td class="p-1">
            <select data-field="parentesco" required 
                class="w-full text-sm rounded border border-gray-300 bg-white px-2 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none cursor-pointer">
                <option value="">Seleccione...</option>
                <option value="Jefe/a">Jefe/a de Hogar</option>
                <option value="Esposo/a">Esposo/a</option>
                <option value="Conviviente">Conviviente</option>
                <option value="Hijo/a">Hijo/a</option>
                <option value="Hijastro/a">Hijastro/a</option>
                <option value="Padre/Madre">Padre/Madre</option>
                <option value="Hermano/a">Hermano/a</option>
                <option value="Nieto/a">Nieto/a</option>
                <option value="Yerno/Nuera">Yerno/Nuera</option>
                <option value="Suegro/a">Suegro/a</option>
                <option value="Abuelo/a">Abuelo/a</option>
                <option value="Otro">Otro</option>
            </select>
        </td>

        <td class="p-1">
            <input type="number" data-field="edad" required min="0" max="120"
                class="w-full bg-transparent border-b border-gray-200 focus:border-blue-500 focus:ring-0 text-sm text-center p-2 outline-none" 
                placeholder="0">
        </td>

        <td class="p-1">
            <select data-field="sexo" required 
                class="w-full text-sm rounded border border-gray-300 bg-white px-2 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none cursor-pointer">
                <option value="">Seleccione...</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
            </select>
        </td>

        <td class="p-1">
            <select data-field="ecivil" required 
                class="w-full text-sm rounded border border-gray-300 bg-white px-2 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none cursor-pointer">
                <option value="">Seleccione...</option>
                <option value="Soltero/a">Soltero/a</option>
                <option value="Casado/a">Casado/a</option>
                <option value="Conviviente">Conviviente</option>
                <option value="Separado/a">Separado/a</option>
                <option value="Divorciado/a">Divorciado/a</option>
                <option value="Viudo/a">Viudo/a</option>
            </select>
        </td>

        <td class="p-1">
            <select data-field="neducativo" required 
                class="w-full text-sm rounded border border-gray-300 bg-white px-2 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none cursor-pointer">
                <option value="">Seleccione...</option>
                <option value="Sin Instrucci칩n">Sin Instrucci칩n</option>
                <option value="Inicial">Inicial</option>
                <option value="Primaria Incompleta">Primaria Incomp.</option>
                <option value="Primaria Completa">Primaria Comp.</option>
                <option value="Secundaria Incompleta">Secundaria Incomp.</option>
                <option value="Secundaria Completa">Secundaria Comp.</option>
                <option value="Superior T칠cnico">Sup. T칠cnico</option>
                <option value="Superior Universitario">Sup. Universitario</option>
            </select>
        </td>

        <td class="p-1">
            <select data-field="ocupacion" required 
                class="w-full text-sm rounded border border-gray-300 bg-white px-2 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none cursor-pointer">
                <option value="">Seleccione...</option>
                <option value="Estudiante">Estudiante</option>
                <option value="Ama de Casa">Ama de Casa</option>
                <option value="Trabajador Independiente">Trab. Independiente</option>
                <option value="Empleado Dependiente">Emp. Dependiente</option>
                <option value="Comerciante">Comerciante</option>
                <option value="Obrero/a">Obrero/a</option>
                <option value="Agricultor/a">Agricultor/a</option>
                <option value="Desempleado/a">Desempleado/a</option>
                <option value="Jubilado/a">Jubilado/a</option>
                <option value="Otro">Otro</option>
            </select>
        </td>

        <td class="p-1">
            <input type="number" data-field="ingresos" step="0.01" min="0" required
                class="w-full bg-transparent border-b border-gray-200 focus:border-blue-500 focus:ring-0 text-sm text-right p-2 outline-none" 
                placeholder="0.00">
        </td>

        <td class="p-1 text-center">
            <button type="button" onclick="eliminarFila(this)" 
                class="text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl transition-all hover:scale-110" 
                title="Eliminar fila">
                &times;
            </button>
        </td>
    `;

            tbody.appendChild(row);
            renumerarFilas();

            // Hacer scroll a la nueva fila
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Focus en el primer campo
            const primerInput = row.querySelector('input[data-field="nombre"]');
            if (primerInput) {
                setTimeout(() => primerInput.focus(), 300);
            }
        }

        function eliminarFila(btn) {
            const row = btn.closest('tr');
            if (row) {
                const confirmar = confirm("쮼st치 seguro que desea eliminar este integrante?");
                if (confirmar) {
                    row.remove();
                    renumerarFilas();
                }
            }
        }

        function renumerarFilas() {
            const tbody = document.getElementById('familiares-body');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');

            rows.forEach((row, index) => {
                const num = index + 1;

                // Actualizar n칰mero de fila
                const indexCell = row.querySelector('.index-cell');
                if (indexCell) {
                    indexCell.innerText = num;
                }

                // Actualizar atributos name para el backend
                const campos = row.querySelectorAll('[data-field]');
                campos.forEach(campo => {
                    const fieldName = campo.getAttribute('data-field');
                    campo.name = `fam_${num}_${fieldName}`;
                });
            });

            // Actualizar input hidden con el total
            const hiddenTotal = document.getElementById('total_familiares');
            if (hiddenTotal) {
                hiddenTotal.value = rows.length;
            }
        }

        // ============================================================================
        // CONSOLA DE DEBUG
        // ============================================================================
        // console.log("九 JavaScript del formulario cargado correctamente");
    </script>
    {% endblock %}